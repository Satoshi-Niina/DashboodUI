name: Deploy to Cloud Run

on:
  push:
    branches: 
      - main
      - master
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  SERVICE_NAME: dashboard-ui
  CLOUD_SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE }}  # ‰æã: project:region:instance

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Google Cloud Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Verify Cloud SQL Instance Name
        run: |
          INSTANCE="${{ secrets.CLOUD_SQL_INSTANCE }}"
          echo "Cloud SQL Instance: $INSTANCE"
          if [[ -z "$INSTANCE" ]]; then
            echo "ERROR: CLOUD_SQL_INSTANCE secret is not set!"
            exit 1
          fi
          if [[ ! "$INSTANCE" =~ ^[a-zA-Z0-9-]+:[a-zA-Z0-9-]+:[a-z][a-z0-9-]+$ ]]; then
            echo "ERROR: Invalid Cloud SQL instance format. Expected: project-id:region:instance-name"
            echo "Got: $INSTANCE"
            exit 1
          fi
      
      - name: Build and Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source . \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars="DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars="DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars="DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars="CORS_ORIGIN=*" \
            --min-instances=0 \
            --max-instances=10 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=600 \
            --cpu-boost \
            --port=3000
      
      - name: Test Health Endpoint
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          echo "Testing health endpoint..."
          sleep 10  # „Çµ„Éº„Éì„ÇπËµ∑Âãï„ÇíÂæÖ„Å§
          curl -f "$SERVICE_URL/health" || echo "Health check failed, but continuing..."
      
      - name: Show Deployment Info
        run: |
          echo "‚úÖ Deployment completed successfully!"
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "üåê Service URL: $SERVICE_URL"
          echo "üîç Health Check: $SERVICE_URL/health"
          echo "üêõ Debug Info: $SERVICE_URL/debug/env"
