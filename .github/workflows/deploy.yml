name: Deploy to Cloud Run

on:
  push:
    branches: 
      - main
      - master
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast2
  SERVICE_NAME: dashboard-ui
  CLOUD_SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE }}  # ‰æã: project:region:instance

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Google Cloud Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker gcr.io --quiet
      
      - name: Clear Docker Cache
        run: |
          echo "üßπ Clearing Docker build cache..."
          docker system prune -af --volumes || true
          docker builder prune -af || true
          echo "‚úÖ Docker cache cleared"
      
      - name: Delete old container images
        run: |
          echo "üóëÔ∏è Deleting old container images from GCR..."
          gcloud container images list --repository=gcr.io/${{ env.PROJECT_ID }} --format="value(name)" | while read IMAGE_NAME; do
            echo "Processing $IMAGE_NAME..."
            gcloud container images list-tags "$IMAGE_NAME" --format="get(digest)" --limit=999 | while read DIGEST; do
              if [ ! -z "$DIGEST" ]; then
                echo "Deleting $IMAGE_NAME@$DIGEST"
                gcloud container images delete "${IMAGE_NAME}@${DIGEST}" --quiet --force-delete-tags || true
              fi
            done
          done
          echo "‚úÖ Old images deleted"
      
      - name: Verify Cloud SQL Instance Name
        run: |
          INSTANCE="${{ secrets.CLOUD_SQL_INSTANCE }}"
          echo "Cloud SQL Instance: $INSTANCE"
          if [[ -z "$INSTANCE" ]]; then
            echo "ERROR: CLOUD_SQL_INSTANCE secret is not set!"
            exit 1
          fi
          if [[ ! "$INSTANCE" =~ ^[a-zA-Z0-9-]+:[a-zA-Z0-9-]+:[a-z][a-z0-9-]+$ ]]; then
            echo "ERROR: Invalid Cloud SQL instance format. Expected: project-id:region:instance-name"
            echo "Got: $INSTANCE"
            exit 1
          fi
      
      - name: Delete existing Cloud Run service (clean deploy)
        run: |
          echo "Checking if service exists..."
          if gcloud run services describe ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --format='value(metadata.name)' 2>/dev/null; then
            echo "Deleting existing service for clean deployment..."
            gcloud run services delete ${{ env.SERVICE_NAME }} \
              --region=${{ env.REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --quiet
            echo "‚úÖ Service deleted successfully"
          else
            echo "Service doesn't exist yet, proceeding with new deployment"
          fi
      
      - name: Build and Deploy to Cloud Run (Clean Build)
        id: deploy
        run: |
          # „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Åß„Ç§„É°„Éº„Ç∏„Çø„Ç∞„ÇíÁîüÊàêÔºà„Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñÔºâ
          TIMESTAMP=$(date +%s)
          IMAGE_TAG="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${TIMESTAMP}"
          
          echo "üî® Building Docker image with timestamp: $TIMESTAMP"
          echo "üö´ Cache disabled: --no-cache"
          echo "üì¶ Image tag: $IMAGE_TAG"
          
          # Docker„Ç§„É°„Éº„Ç∏„Çí„Éì„É´„ÉâÔºàÂÆåÂÖ®„Å´„Ç≠„É£„ÉÉ„Ç∑„É•ÁÑ°ÂäπÂåñÔºâ
          docker build \
            --no-cache \
            --pull \
            --build-arg CACHEBUST=$TIMESTAMP \
            --build-arg BUILDTIME=$(date -Iseconds) \
            -t $IMAGE_TAG .
          
          echo "‚úÖ Build completed"
          
          # GCR„Å´„Éó„ÉÉ„Ç∑„É•
          echo "üì§ Pushing to GCR..."
          docker push $IMAGE_TAG
          echo "‚úÖ Push completed"
          
          # Cloud Run„Å´„Éá„Éó„É≠„Ç§
          echo "üöÄ Deploying to Cloud Run..."
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=$IMAGE_TAG \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="APP_ID=dashboard-ui" \
            --set-env-vars="CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars="DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars="DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars="DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars="CORS_ORIGIN=*" \
            --set-env-vars="BUILD_TIMESTAMP=$TIMESTAMP" \
            --no-traffic \
            --tag="build-${TIMESTAMP}"
          
          echo "‚è≥ Waiting for new revision to be ready..."
          sleep 10
          
          # Êñ∞„Åó„ÅÑ„É™„Éì„Ç∏„Éß„É≥„Å´100%„Éà„É©„Éï„Ç£„ÉÉ„ÇØ„ÇíÂâ≤„ÇäÂΩì„Å¶
          echo "üîÑ Routing 100% traffic to new revision..."
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-latest \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }}
          
          echo "‚úÖ Deployment completed with timestamp: $TIMESTAMP"
      
      - name: Clear CDN/Edge Cache
        run: |
          echo "üßπ Forcing cache invalidation..."
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          
          # Cloud Run„ÅÆCDN„Ç≠„É£„ÉÉ„Ç∑„É•„Çí„ÇØ„É™„Ç¢ÔºàË§áÊï∞„É™„ÇØ„Ç®„Çπ„ÉàÔºâ
          for endpoint in / /admin.html /admin.js /admin.css /index.html /app.js /login.js; do
            echo "Clearing cache for: $endpoint"
            curl -X PURGE "${SERVICE_URL}${endpoint}" || true
            curl -H "Cache-Control: no-cache" "${SERVICE_URL}${endpoint}" > /dev/null 2>&1 || true
          done
          
          echo "‚úÖ Cache invalidation completed"
      
      - name: Show logs on deployment failure
        if: failure() && steps.deploy.outcome == 'failure'
        run: |
          echo "Deployment failed, fetching logs..."
          echo "==================== CLOUD RUN LOGS ===================="
          gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
            --limit=100 \
            --format="table(timestamp,severity,textPayload)" \
            --project=${{ env.PROJECT_ID }} \
            --freshness=5m || echo "Failed to fetch logs"
      
      - name: Test Health Endpoint
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          echo "Testing health endpoint..."
          
          # „Çµ„Éº„Éì„ÇπËµ∑Âãï„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß60ÁßíÔºâ
          MAX_WAIT=60
          WAIT_TIME=0
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if curl -f -s "$SERVICE_URL/health" > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              curl "$SERVICE_URL/health"
              break
            fi
            echo "Waiting for service to be ready... ($WAIT_TIME/$MAX_WAIT)"
            sleep 5
            WAIT_TIME=$((WAIT_TIME + 5))
          done
          
          if [ $WAIT_TIME -ge $MAX_WAIT ]; then
            echo "‚ö†Ô∏è Health check timeout, checking logs..."
            gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
              --limit=50 \
              --format=json \
              --project=${{ env.PROJECT_ID }} || true
          fi
      
      - name: Verify deployed files
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          
          echo "üîç Verifying deployed admin.js contains data-action..."
          RESULT=$(curl -s "${SERVICE_URL}/admin.js" | grep -c "data-action" || echo "0")
          echo "data-action count in deployed file: $RESULT"
          
          if [ "$RESULT" -lt "3" ]; then
            echo "‚ùå ERROR: admin.js does not contain enough data-action attributes!"
            echo "Expected at least 3, got: $RESULT"
            exit 1
          fi
          
          echo "‚úÖ Verification passed: admin.js contains $RESULT data-action attributes"
      
      - name: Show Deployment Info
        run: |
          echo "‚úÖ Deployment completed successfully!"
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "üåê Service URL: $SERVICE_URL"
          echo "üîç Health Check: $SERVICE_URL/health"
          echo "üêõ Debug Info: $SERVICE_URL/debug/env"
