name: Deploy to Cloud Run

on:
  push:
    branches: 
      - main
      - master
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  SERVICE_NAME: dashboard-ui
  CLOUD_SQL_INSTANCE: ${{ secrets.CLOUD_SQL_INSTANCE }}  # ‰æã: project:region:instance

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Google Cloud Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Verify Cloud SQL Instance Name
        run: |
          INSTANCE="${{ secrets.CLOUD_SQL_INSTANCE }}"
          echo "Cloud SQL Instance: $INSTANCE"
          if [[ -z "$INSTANCE" ]]; then
            echo "ERROR: CLOUD_SQL_INSTANCE secret is not set!"
            exit 1
          fi
          if [[ ! "$INSTANCE" =~ ^[a-zA-Z0-9-]+:[a-zA-Z0-9-]+:[a-z][a-z0-9-]+$ ]]; then
            echo "ERROR: Invalid Cloud SQL instance format. Expected: project-id:region:instance-name"
            echo "Got: $INSTANCE"
            exit 1
          fi
      
      - name: Build and Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --source . \
            --project=${{ env.PROJECT_ID }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --add-cloudsql-instances=${{ secrets.CLOUD_SQL_INSTANCE }} \
            --set-env-vars="NODE_ENV=production" \
            --set-env-vars="CLOUD_SQL_INSTANCE=${{ secrets.CLOUD_SQL_INSTANCE }}" \
            --set-env-vars="DB_USER=${{ secrets.DB_USER }}" \
            --set-env-vars="DB_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars="DB_NAME=${{ secrets.DB_NAME }}" \
            --set-env-vars="JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars="CORS_ORIGIN=*" \
            --set-env-vars="PORT=3000" \
            --min-instances=0 \
            --max-instances=10 \
            --memory=1Gi \
            --cpu=2 \
            --timeout=900 \
            --cpu-boost \
            --port=3000 \
            --max-retries=3 \
            --no-cpu-throttling
      
      - name: Test Health Endpoint
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Service URL: $SERVICE_URL"
          echo "Testing health endpoint..."
          
          # „Çµ„Éº„Éì„ÇπËµ∑Âãï„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß60ÁßíÔºâ
          MAX_WAIT=60
          WAIT_TIME=0
          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if curl -f -s "$SERVICE_URL/health" > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
              curl "$SERVICE_URL/health"
              break
            fi
            echo "Waiting for service to be ready... ($WAIT_TIME/$MAX_WAIT)"
            sleep 5
            WAIT_TIME=$((WAIT_TIME + 5))
          done
          
          if [ $WAIT_TIME -ge $MAX_WAIT ]; then
            echo "‚ö†Ô∏è Health check timeout, checking logs..."
            gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=${{ env.SERVICE_NAME }}" \
              --limit=50 \
              --format=json \
              --project=${{ env.PROJECT_ID }} || true
          fi
      
      - name: Show Deployment Info
        run: |
          echo "‚úÖ Deployment completed successfully!"
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "üåê Service URL: $SERVICE_URL"
          echo "üîç Health Check: $SERVICE_URL/health"
          echo "üêõ Debug Info: $SERVICE_URL/debug/env"
