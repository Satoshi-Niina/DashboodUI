<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>設定管理 - Dashboard Admin</title>
    <link rel="stylesheet" href="admin.css?v=20260112-1930">
</head>

<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>🔧 システム設定管理</h1>
            <div class="user-info">
                <span id="admin-user"></span>
                <button id="back-to-main-btn" class="btn-secondary">← メイン画面に戻る</button>
            </div>
        </header>

        <!-- タブメニュー -->
        <div class="tab-menu">
            <button class="tab-button" data-tab="user-management">
                <span class="tab-icon">👥</span>
                <span class="tab-label">ユーザー管理</span>
            </button>
            <button class="tab-button" data-tab="office-master">
                <span class="tab-icon">🏢</span>
                <span class="tab-label">事業所マスタ</span>
            </button>
            <button class="tab-button" data-tab="base-master">
                <span class="tab-icon">🏗️</span>
                <span class="tab-label">保守基地マスタ</span>
            </button>
            <button class="tab-button" data-tab="vehicle-master">
                <span class="tab-icon">🚛</span>
                <span class="tab-label">保守用車マスタ</span>
            </button>
            <button class="tab-button" data-tab="inspection-master">
                <span class="tab-icon">🔧</span>
                <span class="tab-label">検修マスタ</span>
            </button>
            <button class="tab-button" data-tab="database-management">
                <span class="tab-icon">💾</span>
                <span class="tab-label">データベース管理</span>
            </button>
            <button class="tab-button" data-tab="ai-management">
                <span class="tab-icon">🤖</span>
                <span class="tab-label">AI管理</span>
            </button>
            <button class="tab-button" data-tab="cors-settings">
                <span class="tab-icon">🌐</span>
                <span class="tab-label">CORS設定</span>
            </button>
        </div>

        <div class="admin-content">
            <!-- ユーザー管理タブ -->
            <div id="user-management-tab" class="tab-content">
                <div class="info-banner">
                    <p>💡 ログインユーザーの追加・編集・削除を行います</p>
                </div>

                <section class="config-section">
                    <div class="user-actions">
                        <button type="button" id="add-new-user-btn" class="btn-primary">
                            ➕ 新規ユーザー追加
                        </button>
                    </div>

                    <div id="users-list" class="users-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>
            </div>

            <!-- 保守用車マスタタブ -->
            <div id="vehicle-master-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 保守用車の機種と機械番号を管理します。新規に機種・機械番号を登録することもできます。</p>
                </div>

                <!-- 機種マスタ管理 -->
                <section class="config-section">
                    <h3>🔧 機種マスタ</h3>
                    <div class="user-actions">
                        <button type="button" id="add-new-machine-type-btn" class="btn-primary">
                            ➕ 新規機種追加
                        </button>
                    </div>

                    <div id="machine-types-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>

                <!-- 保守用車管理マスタ -->
                <section class="config-section">
                    <h3>🚛 保守用車管理マスタ</h3>
                    <div class="user-actions">
                        <button type="button" id="add-new-machine-btn" class="btn-primary">
                            ➕ 新規保守用車追加
                        </button>
                    </div>

                    <div id="machines-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>

            </div>

            <!-- 事業所マスタタブ -->
            <div id="office-master-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 事業所の情報を管理します</p>
                </div>

                <section class="config-section">
                    <div class="user-actions">
                        <button type="button" id="add-new-office-btn" class="btn-primary">
                            ➕ 新規事業所追加
                        </button>
                    </div>

                    <div id="offices-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>
            </div>

            <!-- 保守基地マスタタブ -->
            <div id="base-master-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 保守基地の情報を管理します</p>
                </div>

                <section class="config-section">
                    <div class="user-actions">
                        <button type="button" id="add-new-base-btn" class="btn-primary">
                            ➕ 新規保守基地追加
                        </button>
                    </div>

                    <div id="bases-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>
            </div>

            <!-- 検修マスタタブ -->
            <div id="inspection-master-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 機種・機械番号毎に検修種別による検修周期（月単位）と検修期間（日）を設定します</p>
                </div>

                <!-- 検修種別マスタ管理 -->
                <section class="config-section">
                    <h3>📋 検修種別マスタ</h3>
                    <div class="user-actions">
                        <button type="button" id="add-new-inspection-type-btn" class="btn-primary">
                            ➕ 新規検修種別追加
                        </button>
                    </div>

                    <div id="inspection-types-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>

                <!-- 検修周期・期間設定 -->
                <section class="config-section">
                    <h3>🔧 検修周期・期間設定</h3>
                    <div class="user-actions">
                        <button type="button" id="add-new-inspection-schedule-btn" class="btn-primary">
                            ➕ 新規検修設定追加
                        </button>
                    </div>

                    <div id="inspection-schedules-list" class="vehicles-list">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>
            </div>

            <!-- データベース管理タブ -->
            <div id="database-management-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 データベースの接続状態、バックアップ、復元を管理します</p>
                </div>

                <!-- 接続状態 -->
                <section class="config-section">
                    <h2>📊 データベース接続状態</h2>
                    <div class="db-status-card">
                        <div class="status-item">
                            <div class="status-label">接続状態</div>
                            <div class="status-value" id="db-connection-status">
                                <span class="status-badge status-checking">確認中...</span>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">バージョン</div>
                            <div class="status-value" id="db-version">--</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">接続数</div>
                            <div class="status-value" id="db-connections">--</div>
                        </div>
                    </div>
                </section>

                <!-- パフォーマンス -->
                <section class="config-section">
                    <h2>⚡ パフォーマンス</h2>
                    <div class="performance-grid">
                        <div class="perf-card">
                            <div class="perf-label">ディスク使用率（実測値）</div>
                            <div class="perf-value" id="disk-usage">--</div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="disk-progress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-label">データベースサイズ（実測値）</div>
                            <div class="perf-value" id="db-size">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-label">接続数</div>
                            <div class="perf-value" id="connection-count">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-label">稼働時間</div>
                            <div class="perf-value" id="uptime">--</div>
                        </div>
                    </div>
                </section>

                <!-- テーブルサイズ -->
                <section class="config-section">
                    <h2>📦 テーブルサイズ（実測値・上位10件）</h2>
                    <div id="table-sizes" class="table-sizes">
                        <p class="loading">読み込み中...</p>
                    </div>
                </section>

                <!-- テーブル管理 -->
                <section class="config-section">
                    <h2>🗂️ テーブルデータ管理</h2>
                    <div class="table-selector">
                        <label for="table-select">テーブル選択:</label>
                        <select id="table-select">
                            <option value="">-- テーブルを選択 --</option>
                            <option value="master_data.users">ユーザー (master_data.users)</option>
                            <option value="master_data.managements_offices">事業所 (master_data.managements_offices)
                            </option>
                            <option value="master_data.bases">保守基地 (master_data.bases)</option>
                            <option value="master_data.machines">保守用車管理 (master_data.machines)</option>
                            <option value="master_data.machine_types">機種 (master_data.machine_types)</option>
                            <option value="operations.schedules">運転計画 (operations.schedules)</option>
                            <option value="maintenance.fault_records">故障記録 (maintenance.fault_records)</option>
                            <option value="master_data.inspection_types">検修種別マスタ (master_data.inspection_types)</option>
                            <option value="master_data.inspection_schedules">検修周期・期間設定 (master_data.inspection_schedules)</option>
                        </select>
                        <button id="load-table-btn" class="btn-primary">📋 読み込み</button>
                        <button id="add-record-btn" class="btn-success">➕ 新規追加</button>
                    </div>

                    <div id="table-data-container" class="table-data-container">
                        <p class="info-text">テーブルを選択して「読み込み」ボタンをクリックしてください</p>
                    </div>
                </section>

                <!-- バックアップ・復元 -->
                <section class="config-section">
                    <h2>💾 バックアップ・復元</h2>
                    <div class="backup-controls">
                        <button id="backup-db-btn" class="btn-warning">
                            📦 データベースバックアップ
                        </button>
                        <button id="restore-db-btn" class="btn-danger">
                            ⚠️ バックアップから復元
                        </button>
                        <input type="file" id="restore-file-input" accept=".sql,.backup" style="display:none;">
                    </div>
                </section>

                <!-- データ入出力 -->
                <section class="config-section">
                    <h2>📤 データ入出力</h2>
                    <div class="import-export-controls">
                        <button id="export-csv-btn" class="btn-info" disabled>
                            📤 CSVエクスポート
                        </button>
                        <button id="import-csv-btn" class="btn-info" disabled>
                            📥 CSVインポート
                        </button>
                        <input type="file" id="import-csv-file" accept=".csv" style="display:none;">
                    </div>
                    <p class="info-text">※ テーブルを選択すると使用できます</p>
                </section>
            </div>

            <section class="config-section" style="display: none;">
                <h2>アプリケーション URL 設定</h2>
                <p class="section-desc">各サブシステムの接続先URLを設定します</p>

                <form id="config-form">
                    <div class="form-group">
                        <label for="app_url_emergency">
                            🛠️ 応急復旧支援システム
                        </label>
                        <input type="url" id="app_url_emergency" name="app_url_emergency"
                            placeholder="https://emergency-client-xxx.run.app" required>
                        <small>完全なURL（https://...）を入力してください</small>
                    </div>

                    <div class="form-group">
                        <label for="app_url_planning">
                            📅 計画・実績管理システム
                        </label>
                        <input type="url" id="app_url_planning" name="app_url_planning"
                            placeholder="https://planning-xxx.run.app" required>
                    </div>

                    <div class="form-group">
                        <label for="app_url_equipment">
                            🚛 保守用車管理システム
                        </label>
                        <input type="url" id="app_url_equipment" name="app_url_equipment"
                            placeholder="https://equipment-xxx.run.app" required>
                    </div>

                    <div class="form-group">
                        <label for="app_url_failure">
                            ⚠️ 機械故障管理システム
                        </label>
                        <input type="url" id="app_url_failure" name="app_url_failure"
                            placeholder="https://failure-xxx.run.app" required>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">
                            💾 設定を保存
                        </button>
                    </div>
                </form>
            </section>

            <!-- CORS設定タブ -->
            <div id="cors-settings-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 異なるドメインからのAPIアクセスを制御します</p>
                </div>

                <section class="config-section">
                    <h2>🌐 CORS 許可オリジン設定</h2>

                    <div class="form-group">
                        <label for="cors_origin">
                            CORS 許可オリジン
                        </label>
                        <input type="text" id="cors_origin" name="cors_origin"
                            placeholder="* または https://domain1.com,https://domain2.com">
                        <small class="small-text">複数指定する場合はカンマ区切り。すべて許可する場合は * を入力</small>
                        <div class="info-box">
                            <strong class="small-text">📌 CORS（Cross-Origin Resource Sharing）とは？</strong><br>
                            <span class="small-text">異なるドメインからこのサーバーのAPIにアクセスすることを許可するセキュリティ設定です。</span><br>
                            <br>
                            <strong class="small-text">設定例：</strong><br>
                            <span class="small-text">• <code>*</code> - すべてのドメインからのアクセスを許可（開発環境推奨）</span><br>
                            <span class="small-text">• <code>https://example.com</code> - 特定のドメインのみ許可（本番環境推奨）</span><br>
                            <span class="small-text">• <code>https://app1.com,https://app2.com</code> -
                                複数ドメインを許可</span><br>
                            <br>
                            <strong class="small-text">⚠️ セキュリティ上の注意：</strong><br>
                            <span class="small-text">本番環境では必要なドメインのみを指定することを強く推奨します。</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="save-cors-btn" class="btn-primary">
                            💾 CORS設定を保存
                        </button>
                    </div>
                </section>
            </div>

            <!-- AI管理タブ -->
            <div id="ai-management-tab" class="tab-content" style="display: none;">
                <div class="info-banner">
                    <p>💡 Gemini AIのナレッジデータインポート、RAG設定、AI支援調整を行います</p>
                </div>

                <!-- サブタブメニュー -->
                <div class="sub-tab-menu">
                    <button class="sub-tab-button active" data-subtab="ai-import">
                        📥 データインポート
                    </button>
                    <button class="sub-tab-button" data-subtab="ai-knowledge">
                        📚 ナレッジ管理
                    </button>
                    <!-- AI支援調整は応急復旧支援アプリへ移動 -->
                    <button class="sub-tab-button" data-subtab="ai-rag">
                        ⚙️ RAG詳細設定
                    </button>
                </div>

                <!-- データインポートサブタブ -->
                <div id="ai-import-subtab" class="sub-tab-content">
                    <section class="config-section">
                        <h3>📥 機械故障情報インポート</h3>
                        <p class="section-desc">チャット履歴から保存されたJSONファイルをインポートし、AIの知識に加えます</p>
                        
                        <div class="form-group">
                            <label for="fault-json-file" style="font-size: 1.2em;">エクスポート済みJSONファイルを選択</label>
                            <input type="file" id="fault-json-file" accept=".json" class="file-input" style="font-size: 1.2em; border: 2px dashed #333;">
                        </div>
                        
                        <button type="button" id="import-fault-json-btn" class="btn-primary">
                            📤 機械故障報告をインポート
                        </button>
                    </section>

                    <section class="config-section">
                        <h3>📄 基礎マニュアルファイルインポート</h3>
                        <p class="section-desc">PDF、TXT、XLSX形式のマニュアルファイルをインポートします（複数選択可能）</p>
                        
                        <div class="upload-area" id="manual-upload-area">
                            <input type="file" id="manual-files" multiple accept=".pdf,.txt,.xlsx,.docx,.md" class="file-input" style="display: none;">
                            <label for="manual-files" class="upload-label">
                                <div class="upload-content">
                                    <span class="upload-icon">📁</span>
                                    <p>クリックしてファイルを選択 (PDF, TXT, XLSX, DOCX, MD)</p>
                                    <p class="upload-hint">複数選択可能 | 最大100MB</p>
                                </div>
                            </label>
                        </div>
                        
                        <div id="manual-file-list" class="file-list"></div>
                        
                        <div class="form-group">
                            <label class="checkbox-inline-label">
                                <span class="checkbox-text">元のファイルをアーカイブ保存する（通常不要）</span>
                                <input type="checkbox" id="save-original-file" class="checkbox-compact">
                            </label>
                        </div>
                        
                        <button type="button" id="import-manuals-btn" class="btn-primary">
                            📤 インポート実行
                        </button>
                    </section>

                    <section class="config-section">
                        <h3>☁️ GCSストレージからインポート</h3>
                        <p class="section-desc">Google Cloud Storageに既存のファイルを直接インポートします</p>
                        
                        <div class="form-group">
                            <label for="gcs-file-path">GCSファイルパス</label>
                            <input type="text" id="gcs-file-path" placeholder="knowledge-data/manual-2024.pdf">
                            <small>バケット内のファイルパスを入力してください</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="gcs-description">説明</label>
                            <textarea id="gcs-description" cols="70" rows="6" placeholder="このファイルの内容を簡単に説明してください" style="resize: both; width: 100%; min-width: 600px; font-size: 14px; padding: 10px;"></textarea>
                        </div>
                        
                        <button type="button" id="import-gcs-btn" class="btn-primary">
                            ☁️ GCSからインポート
                        </button>
                    </section>
                </div>

                <!-- ナレッジ管理サブタブ -->
                <div id="ai-knowledge-subtab" class="sub-tab-content" style="display: none;">
                    <section class="config-section">
                        <h3>📊 ストレージ統計</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">総ファイル数</div>
                                <div class="stat-value" id="stat-total-files">0</div>
                                <div class="stat-unit">件</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">総容量</div>
                                <div class="stat-value" id="stat-total-size">0</div>
                                <div class="stat-unit">MB</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">アクティブファイル</div>
                                <div class="stat-value" id="stat-active-files">0</div>
                                <div class="stat-unit">件</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ローカルアップロード</div>
                                <div class="stat-value" id="stat-local-uploads">0</div>
                                <div class="stat-unit">件</div>
                            </div>
                        </div>
                    </section>

                    <section class="config-section">
                        <h3>📚 ナレッジデータ一覧</h3>
                        <div class="knowledge-actions" style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button type="button" id="refresh-knowledge-btn" class="btn-secondary">
                                🔄 更新
                            </button>
                        </div>
                        <div id="knowledge-data-list" class="knowledge-list">
                            <p class="loading">読み込み中...</p>
                        </div>
                    </section>
                </div>
                <!-- AI支援調整サブタブ削除 -->

                <!-- RAG詳細設定サブタブ -->
                <div id="ai-rag-subtab" class="sub-tab-content" style="display: none;">
                    <!-- RAG (Retrieval-Augmented Generation) 設定 -->
                    <section class="config-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: white; margin: 0;">⚙️ RAG (Retrieval-Augmented Generation) 設定</h3>
                        <p style="margin: 10px 0 0 0; font-size: 0.9em; opacity: 0.95;">AIがナレッジベースから情報を取得し、精度の高い回答を生成するための設定を行います</p>
                    </section>

                    <!-- テキスト分割設定 -->
                    <section class="config-section">
                        <h3>📄 テキスト分割設定</h3>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px;">ナレッジデータを適切なサイズに分割し、検索精度を向上させます</p>
                        
                        <div class="form-group" style="display: flex !important; gap: 40px !important; align-items: flex-start !important;">
                            <div style="width: 420px !important;">
                                <label for="rag-chunk-size" style="font-size: 1.2em !important; font-weight: 600 !important; display: block !important;">
                                    チャンクサイズ: <span id="chunk-size-value">500</span>文字
                                </label>
                                <input type="range" id="rag-chunk-size" min="200" max="2000" step="100" value="500" class="slider" style="width: 420px !important; display: block !important;">
                                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">各テキストチャンクの最大文字数（200〜2000文字）</p>
                            </div>
                            
                            <div style="width: 420px !important;">
                                <label for="rag-overlap" style="font-size: 1.2em !important; font-weight: 600 !important; display: block !important;">
                                    オーバーラップ: <span id="overlap-value">100</span>文字
                                </label>
                                <input type="range" id="rag-overlap" min="0" max="500" step="50" value="100" class="slider" style="width: 420px !important; display: block !important;">
                                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">チャンク間で重複させる文字数（0〜500文字）</p>
                            </div>
                        </div>
                    </section>

                    <!-- 検索精度設定 -->
                    <section class="config-section">
                        <h3>🎯 検索精度設定</h3>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px;">AI検索の精度と結果数を調整します</p>
                        
                        <div class="form-group" style="display: flex !important; gap: 40px !important; align-items: flex-start !important;">
                            <div style="width: 420px !important;">
                                <label for="rag-similarity" style="font-size: 1.2em !important; font-weight: 600 !important; display: block !important;">
                                    類似度閾値: <span id="similarity-value">0.7</span>
                                </label>
                                <input type="range" id="rag-similarity" min="0" max="100" step="5" value="70" class="slider" style="width: 420px !important; display: block !important;">
                                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">検索結果として採用する最低類似度（0.0〜1.0）</p>
                            </div>
                            
                            <div style="width: auto !important;">
                                <label for="rag-max-results" style="font-size: 1.2em !important; font-weight: 600 !important; display: block !important;">
                                    最大取得件数
                                </label>
                                <input type="number" id="rag-max-results" value="5" min="1" max="20" style="width: 5em !important; display: block !important; font-size: 1.5em !important;">
                                <p style="font-size: 0.85em; color: #666; margin-top: 5px;">AIに提供する検索結果の最大数（1〜20件）</p>
                            </div>
                        </div>
                    </section>

                    <!-- 検索手法 -->
                    <section class="config-section">
                        <h3>🔍 検索手法</h3>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px; font-size: 1.1em;">ナレッジ検索に使用するアルゴリズムを選択します</p>
                        
                        <div class="form-group">
                            <div style="display: flex; gap: 26px; flex-wrap: wrap;">
                                <label class="radio-option" style="display: flex; align-items: center; padding: 16px 20px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                    <input type="radio" name="search-method" value="vector" checked style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.15em;">
                                        <strong style="font-size: 1.2em;">ベクトル検索</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">意味が似ている内容を探す（AIが文章の意味を理解）</small>
                                    </span>
                                </label>
                                <label class="radio-option" style="display: flex; align-items: center; padding: 16px 20px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                    <input type="radio" name="search-method" value="keyword" style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.15em;">
                                        <strong style="font-size: 1.2em;">キーワード検索</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">完全一致・部分一致で探す（入力した単語と同じ単語を検索）</small>
                                    </span>
                                </label>
                                <label class="radio-option" style="display: flex; align-items: center; padding: 16px 20px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                                    <input type="radio" name="search-method" value="hybrid" style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.15em;">
                                        <strong style="font-size: 1.2em;">ハイブリッド検索</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">ベクトル + キーワードの両方を使う（精度が高い）</small>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <h4 style="margin-top: 32px; margin-bottom: 13px; font-size: 1.3em;">📝 テキスト前処理</h4>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px; font-size: 1.1em;">検索前にテキストに適用する前処理を選択します</p>
                        
                        <div class="form-group">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">
                                <label class="checkbox-option" style="display: flex; align-items: center; padding: 16px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" id="preprocessing-stopwords" checked style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.1em;">
                                        <strong style="font-size: 1.15em;">ストップワード除去</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">「の」「は」など意味のない単語を自動で削除</small>
                                    </span>
                                </label>
                                <label class="checkbox-option" style="display: flex; align-items: center; padding: 16px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" id="preprocessing-stemming" style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.1em;">
                                        <strong style="font-size: 1.15em;">ステミング処理</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">語幹を抽出して同じ意味の言葉をまとめる（例：走る→走）</small>
                                    </span>
                                </label>
                                <label class="checkbox-option" style="display: flex; align-items: center; padding: 16px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" id="preprocessing-lowercase" checked style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.1em;">
                                        <strong style="font-size: 1.15em;">小文字変換</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">全て小文字に統一（ABC→abc）</small>
                                    </span>
                                </label>
                                <label class="checkbox-option" style="display: flex; align-items: center; padding: 16px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" id="preprocessing-normalize" checked style="margin-right: 13px; width: 20px; height: 20px;">
                                    <span style="font-size: 1.1em;">
                                        <strong style="font-size: 1.15em;">文字正規化</strong><br>
                                        <small style="color: #666; font-size: 0.9em;">全角/半角、旧字体を統一（１→1、髙→高など）</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </section>

                    <section class="config-section">
                        <h3>📝 システムプロンプト（AI回答ルール）</h3>
                        
                        <div class="form-group">
                            <textarea id="rag-system-prompt" cols="150" rows="12" style="resize: both; width: 100%; min-width: 600px; min-height: 280px; max-width: 100%; font-family: 'Segoe UI', sans-serif; font-size: 18px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">【回答ルール】
1. ユーザーの質問に対して1問1答形式で回答する
2. 専門的な内容も分かりやすく説明する
3. 安全に関わる情報は特に慎重に扱う
4. 不明な点は推測せず、正直に分からないと伝える</textarea>
                        </div>
                    </section>

                    <section class="config-section">
                        <div class="form-actions">
                            <button type="button" id="save-rag-settings-btn" class="btn-primary">
                                💾 RAG設定を保存
                            </button>
                        </div>
                    </section>

                    <!-- 現在のRAG設定 -->
                    <section class="config-section" style="background-color: #f8f9fa; border-left: 4px solid #667eea;">
                        <h3>📊 現在のRAG設定</h3>
                        <div id="current-rag-settings" style="font-family: 'Courier New', monospace; background: white; padding: 15px; border-radius: 6px; margin-top: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <strong>チャンクサイズ:</strong> <span id="display-chunk-size">-</span>文字
                                </div>
                                <div>
                                    <strong>オーバーラップ:</strong> <span id="display-overlap">-</span>文字
                                </div>
                                <div>
                                    <strong>類似度閾値:</strong> <span id="display-similarity">-</span>
                                </div>
                                <div>
                                    <strong>最大取得件数:</strong> <span id="display-max-results">-</span>件
                                </div>
                                <div>
                                    <strong>検索手法:</strong> <span id="display-search-method">-</span>
                                </div>
                                <div>
                                    <strong>テキスト前処理:</strong> <span id="display-preprocessing">-</span>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                <strong>最終更新:</strong> <span id="display-last-updated">-</span>
                            </div>
                        </div>
                    </section>

                    <!-- RAGパフォーマンステスト -->
                    <section class="config-section">
                        <h3>🧪 RAGパフォーマンステスト</h3>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px;">現在の設定でRAGシステムの動作を検証します</p>
                        
                        <div class="form-group">
                            <label for="test-query" style="display: block; margin-bottom: 8px; font-weight: 600;">テストクエリ（質問）:</label>
                            <input type="text" id="test-query" placeholder="例: 保守用車の点検方法について教えてください" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em;">
                        </div>
                        
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">検証項目:</label>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <label class="checkbox-option" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 1.4em; white-space: nowrap;">検索速度測定</span>
                                    <input type="checkbox" checked disabled style="margin-left: 8px;">
                                </label>
                                <label class="checkbox-option" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 1.4em; white-space: nowrap;">関連性スコア分析</span>
                                    <input type="checkbox" checked disabled style="margin-left: 8px;">
                                </label>
                                <label class="checkbox-option" style="display: flex; align-items: center; justify-content: space-between;">
                                    <span style="font-size: 1.4em; white-space: nowrap;">取得チャンク確認</span>
                                    <input type="checkbox" checked disabled style="margin-left: 8px;">
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="test-rag-btn" class="btn-secondary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                🧪 パフォーマンステスト実行
                            </button>
                        </div>
                    </section>

                    <!-- GCS接続診断 -->
                    <section class="config-section" style="border: 2px solid #34a853;">
                        <h3>☁️ GCS接続診断</h3>
                        <p class="section-desc" style="color: #666; margin-bottom: 15px;">Google Cloud Storageへの接続状態とバケット構成を診断します</p>
                        
                        <div id="gcs-diagnosis-result" style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; display: none;">
                            <div id="gcs-diagnosis-content"></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" id="diagnose-gcs-btn" class="btn-secondary" style="background: linear-gradient(135deg, #34a853 0%, #0f9d58 100%); color: white;">
                                🔍 GCS接続診断を実行
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            <strong>💡 診断内容:</strong>
                            <ul style="margin: 8px 0 0 20px; font-size: 0.9em;">
                                <li>GCSバケットへの接続確認</li>
                                <li>必要なフォルダ構造の検証（manuals/processed/, chat-exports/json/）</li>
                                <li>アクセス権限の確認</li>
                                <li>ストレージ使用状況の取得</li>
                            </ul>
                        </div>
                    </section>
                </div>
            </div>

            <!-- RAGテスト結果モーダル -->
            <div id="rag-test-result-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>🧪 RAGパフォーマンステスト結果</h3>
                    </div>
                    <div class="modal-body" id="rag-test-result-body">
                        <!-- テスト結果がここに表示されます -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="close-rag-test-modal" class="btn-secondary">✖ 終了</button>
                    </div>
                </div>
            </div>

            <section class="config-section" style="display: none;">
                <h2>ユーザー管理</h2>
                <p class="section-desc">ログインユーザーの追加・編集・削除を行います</p>

                <div class="user-actions">
                    <a href="/user-management" class="btn-primary"
                        style="display: inline-block; text-decoration: none; text-align: center;">
                        👥 ユーザー管理を開く
                    </a>
                </div>
            </section>
        </div>
    </div>

    <!-- ユーザー追加・編集モーダル -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">ユーザーを追加</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-id" name="user_id">

                <div class="form-group">
                    <label for="user-username">ユーザー名 *</label>
                    <input type="text" id="user-username" name="username" required>
                </div>

                <div class="form-group">
                    <label for="user-full-name">表示名 *</label>
                    <input type="text" id="user-full-name" name="full_name" required>
                </div>

                <div class="form-group">
                    <label for="user-email">メールアドレス</label>
                    <input type="email" id="user-email" name="email" autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="user-password">パスワード <span id="password-required-label">*</span></label>
                    <input type="password" id="user-password" name="password" autocomplete="new-password">
                    <small id="password-help">新規登録時は必須です。編集時は変更する場合のみ入力してください。</small>
                </div>

                <div class="form-group">
                    <label for="user-role">役割 *</label>
                    <select id="user-role" name="role" required>
                        <option value="user">一般ユーザー</option>
                        <option value="operation_admin">運用管理者</option>
                        <option value="system_admin">システム管理者</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="submit-user-btn">保存</button>
                    <button type="button" class="btn-secondary" id="cancel-user-btn">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 機種マスタ追加・編集モーダル -->
    <div id="machine-type-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="machine-type-modal-title">機種を追加</h3>
                <button class="modal-close" id="machine-type-modal-close">&times;</button>
            </div>
            <form id="machine-type-form">
                <input type="hidden" id="machine-type-id" name="machine_type_id">

                <div class="form-group">
                    <label for="machine-type-model-name">メーカー型式 *</label>
                    <input type="text" id="machine-type-model-name" name="model_name" required placeholder="例: PC200-10">
                </div>

                <div class="form-group">
                    <label for="machine-type-manufacturer">メーカー</label>
                    <input type="text" id="machine-type-manufacturer" name="manufacturer" placeholder="例: コマツ">
                </div>

                <div class="form-group">
                    <label for="machine-type-category">カテゴリ *</label>
                    <select id="machine-type-category" name="category" required>
                        <option value="">選択してください</option>
                        <option value="軌道モータカー">軌道モータカー</option>
                        <option value="箱トロ">箱トロ</option>
                        <option value="鉄トロ">鉄トロ</option>
                        <option value="レールカッター">レールカッター</option>
                        <option value="油圧ショベル">油圧ショベル</option>
                        <option value="クレーン">クレーン</option>
                        <option value="その他">その他</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="machine-type-description">説明</label>
                    <textarea id="machine-type-description" name="description" rows="3" placeholder="説明文を入力"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">保存</button>
                    <button type="button" class="btn-secondary" id="cancel-machine-type-btn">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 保守用車管理マスタ追加・編集モーダル -->
    <div id="machine-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="machine-modal-title">保守用車を追加</h3>
                <button class="modal-close" id="machine-modal-close">&times;</button>
            </div>
            <form id="machine-form">
                <input type="hidden" id="machine-id" name="machine_id">

                <div class="form-group">
                    <label for="machine-office-select">管理事業所 *</label>
                    <select id="machine-office-select" name="office_id" required>
                        <option value="">-- 事業所を選択 --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="machine-type-select">機種 *</label>
                    <select id="machine-type-select" name="machine_type_id" required>
                        <option value="">-- 機種を選択 --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="machine-number">機械番号 *</label>
                    <input type="text" id="machine-number" name="machine_number" required placeholder="例: M-12345">
                </div>

                <div class="form-group">
                    <label for="machine-serial-number">シリアル番号</label>
                    <input type="text" id="machine-serial-number" name="serial_number" placeholder="例: SN123456789">
                </div>

                <div class="form-group">
                    <label for="machine-type-certification">型式認定</label>
                    <input type="text" id="machine-type-certification" name="type_certification"
                        placeholder="例: ABC-123">
                </div>

                <div class="form-group">
                    <label for="machine-manufacture-date">製造年月日</label>
                    <input type="date" id="machine-manufacture-date" name="manufacture_date">
                </div>

                <div class="form-group">
                    <label for="machine-purchase-date">購入年月日</label>
                    <input type="date" id="machine-purchase-date" name="purchase_date">
                </div>

                <div class="form-group">
                    <label for="machine-notes">備考</label>
                    <textarea id="machine-notes" name="notes" rows="3"></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">保存</button>
                    <button type="button" class="btn-secondary" id="cancel-machine-btn">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 検修種別追加・編集モーダル -->
    <div id="inspection-type-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="inspection-type-modal-title">検修種別を追加</h3>
                <button class="modal-close" id="inspection-type-modal-close">&times;</button>
            </div>
            <form id="inspection-type-form">
                <input type="hidden" id="inspection-type-id" name="id">
                
                <div class="form-group">
                    <label for="inspection-type-code">種別コード</label>
                    <input type="text" id="inspection-type-code" name="type_code" placeholder="自動採番（変更可）">
                    <small>空欄の場合は自動で生成されます</small>
                </div>

                <div class="form-group">
                    <label for="inspection-type-name">検修種別名 *</label>
                    <input type="text" id="inspection-type-name" name="type_name" required placeholder="例: A検修">
                    <small>検修種別コードは自動で生成されます</small>
                </div>

                <div class="form-group">
                    <label for="inspection-type-description">説明</label>
                    <textarea id="inspection-type-description" name="description" rows="3" placeholder="検修種別の説明を入力"></textarea>
                </div>

                <div class="form-group">
                    <label for="inspection-type-order">表示順序</label>
                    <input type="number" id="inspection-type-order" name="display_order" value="0" min="0">
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="inspection-type-active" name="is_active" checked>
                        有効
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">保存</button>
                    <button type="button" class="btn-secondary" id="cancel-inspection-type-btn">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 検修周期・期間設定モーダル -->
    <div id="inspection-schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="inspection-schedule-modal-title">検修設定を追加</h3>
                <button class="modal-close" id="inspection-schedule-modal-close">&times;</button>
            </div>
            <form id="inspection-schedule-form">
                <input type="hidden" id="inspection-schedule-id" name="id">

                <div class="form-group">
                    <label for="inspection-schedule-category">カテゴリー (機種個別設定でない場合)</label>
                    <select id="inspection-schedule-category" name="target_category">
                        <option value="">-- カテゴリーを選択 --</option>
                        <option value="軌道モータカー">軌道モータカー</option>
                        <option value="箱トロ">箱トロ</option>
                        <option value="鉄トロ">鉄トロ</option>
                        <option value="レールカッター">レールカッター</option>
                        <option value="油圧ショベル">油圧ショベル</option>
                        <option value="クレーン">クレーン</option>
                        <option value="その他">その他</option>
                    </select>
                    <small>カテゴリー単位で設定する場合に選択してください</small>
                </div>

                <div class="form-group">
                    <label for="inspection-schedule-machine">保守用車 (個別設定)</label>
                    <select id="inspection-schedule-machine" name="machine_id">
                        <option value="">-- 保守用車を選択 --</option>
                    </select>
                    <small>特定の保守用車に設定する場合に選択してください（カテゴリーより優先されます）</small>
                </div>

                <div class="form-group">
                    <label for="inspection-schedule-type">検修種別 *</label>
                    <select id="inspection-schedule-type" name="inspection_type_id" required>
                        <option value="">-- 検修種別を選択 --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="inspection-schedule-cycle">検修周期（月単位） *</label>
                    <input type="number" id="inspection-schedule-cycle" name="cycle_months" required min="1" placeholder="例: 6">
                    <small>検修を実施する周期を月単位で入力してください</small>
                </div>

                <div class="form-group">
                    <label for="inspection-schedule-duration">検修期間（日数） *</label>
                    <input type="number" id="inspection-schedule-duration" name="duration_days" required min="1" placeholder="例: 7">
                    <small>検修にかかる期間を日数で入力してください</small>
                </div>

                <div class="form-group">
                    <label for="inspection-schedule-remarks">備考</label>
                    <textarea id="inspection-schedule-remarks" name="remarks" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="inspection-schedule-active" name="is_active" checked>
                        有効
                    </label>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">保存</button>
                    <button type="button" class="btn-secondary" id="cancel-inspection-schedule-btn">キャンセル</button>
                </div>
            </form>
        </div>
    </div>

    <!-- トースト通知 -->
    <div id="toast" class="toast"></div>

    <script src="admin.js?v=20260107-1715"></script>
</body>

</html>